#!/usr/bin/env python3
"""
ÏÉàÎ°úÏö¥ Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ - Í≤åÏù¥ÏßÄ Ï∞®Ìä∏ÏôÄ ÎèÑÎÑõ Ï∞®Ìä∏Î•º ÏÇ¨Ïö©Ìïú ÌòÑÌô©/ÏòàÏ∏° ÎåÄÏãúÎ≥¥Îìú
"""

import uvicorn
from fastapi import FastAPI, Request, Query
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
import json
import os
from datetime import datetime, timedelta
import random
import math

# FastAPI Ïï± ÏÉùÏÑ±
web_app = FastAPI(title="Energy Analysis Web Interface", version="2.0")

# MCP ÎèÑÍµ¨ Îì±Î°ù Ìï®Ïàò (Í∏∞Ï°¥Í≥º ÎèôÏùº)
def register_tools():
    """MCP ÎèÑÍµ¨Îì§ÏùÑ Îì±Î°ù"""
    pass

@web_app.get("/", response_class=HTMLResponse)
async def home_page(request: Request, lang: str = Query("ko", description="Language code")):
    """ÌôàÌéòÏù¥ÏßÄ"""
    return f"""
    <!DOCTYPE html>
    <html lang="{lang}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üåû Energy Analysis Platform</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-gauge@0.3.0/dist/chartjs-gauge.min.js"></script>
        <style>
            body {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }}
            .main-card {{ background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }}
            .metric-card {{ background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; border-radius: 15px; transition: transform 0.3s; }}
            .metric-card:hover {{ transform: translateY(-5px); }}
            .metric-card.success {{ background: linear-gradient(135deg, #00b894, #00a085); }}
            .metric-card.warning {{ background: linear-gradient(135deg, #fdcb6e, #e17055); }}
            .metric-card.info {{ background: linear-gradient(135deg, #74b9ff, #0984e3); }}
            .chart-container {{ position: relative; height: 300px; margin: 20px 0; }}
            .gauge-container {{ position: relative; height: 200px; margin: 20px 0; }}
            .status-indicator {{ 
                width: 12px; height: 12px; border-radius: 50%; 
                display: inline-block; margin-right: 8px; 
                animation: pulse 2s infinite;
            }}
            .status-past {{ background-color: #ff6b6b; }}
            .status-current {{ background-color: #00b894; }}
            .status-future {{ background-color: #e17055; }}
            @keyframes pulse {{ 0% {{ opacity: 1; }} 50% {{ opacity: 0.5; }} 100% {{ opacity: 1; }} }}
            .prediction-card {{ background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; border-radius: 15px; }}
        </style>
    </head>
    <body>
        <div class="container-fluid py-4">
            <div class="row justify-content-center">
                <div class="col-12 col-xl-10">
                    <div class="main-card p-4">
                        <!-- Ìó§Îçî -->
                        <div class="text-center mb-4">
                            <h1 class="display-4 fw-bold text-primary">
                                <i class="fas fa-sun"></i> Energy Analysis Platform
                            </h1>
                            <p class="lead text-muted">Real-time Weather & Energy Monitoring Dashboard</p>
                        </div>

                        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
                        <nav class="navbar navbar-expand-lg navbar-light bg-light rounded mb-4">
                            <div class="container-fluid">
                                <a class="navbar-brand fw-bold" href="/">
                                    <i class="fas fa-home"></i> Home
                                </a>
                                <div class="navbar-nav ms-auto">
                                    <a class="nav-link" href="/data-collection?lang={lang}">
                                        <i class="fas fa-chart-line"></i> Data Collection
                                    </a>
                                    <a class="nav-link" href="/data-analysis?lang={lang}">
                                        <i class="fas fa-chart-bar"></i> Analysis
                                    </a>
                                </div>
                            </div>
                        </nav>

                        <!-- Î©îÏù∏ ÎåÄÏãúÎ≥¥Îìú -->
                        <div class="row">
                            <!-- ÏôºÏ™Ω: Ïã§ÏãúÍ∞Ñ Î©îÌä∏Î¶≠ -->
                            <div class="col-md-6">
                                <h3 class="mb-3"><i class="fas fa-tachometer-alt"></i> Real-time Metrics</h3>
                                
                                <!-- Î©îÌä∏Î¶≠ Ïπ¥ÎìúÎì§ -->
                                <div class="row mb-4">
                                    <div class="col-6 mb-3">
                                        <div class="metric-card p-3 text-center">
                                            <i class="fas fa-thermometer-half fa-2x mb-2"></i>
                                            <h4 id="currentTemp">24.5¬∞C</h4>
                                            <small>Temperature</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="metric-card success p-3 text-center">
                                            <i class="fas fa-tint fa-2x mb-2"></i>
                                            <h4 id="currentHumidity">65%</h4>
                                            <small>Humidity</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="metric-card warning p-3 text-center">
                                            <i class="fas fa-wind fa-2x mb-2"></i>
                                            <h4 id="currentWind">2.3 m/s</h4>
                                            <small>Wind Speed</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="metric-card info p-3 text-center">
                                            <i class="fas fa-sun fa-2x mb-2"></i>
                                            <h4 id="currentSolar">850 W/m¬≤</h4>
                                            <small>Solar Radiation</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- ÏÉÅÌÉú ÌëúÏãúÍ∏∞ -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5><i class="fas fa-info-circle"></i> Data Status</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span><span class="status-indicator status-past"></span>Past Data</span>
                                            <span class="badge bg-secondary">60%</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span><span class="status-indicator status-current"></span>Current Data</span>
                                            <span class="badge bg-success">20%</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><span class="status-indicator status-future"></span>Prediction</span>
                                            <span class="badge bg-warning">20%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ïò§Î•∏Ï™Ω: Í≤åÏù¥ÏßÄ Ï∞®Ìä∏Îì§ -->
                            <div class="col-md-6">
                                <h3 class="mb-3"><i class="fas fa-chart-pie"></i> Current Status & Prediction</h3>
                                
                                <!-- Ïò®ÎèÑ Í≤åÏù¥ÏßÄ -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="gauge-container">
                                            <canvas id="tempGauge"></canvas>
                                        </div>
                                        <h6 class="text-center">Temperature</h6>
                                    </div>
                                    <div class="col-6">
                                        <div class="gauge-container">
                                            <canvas id="humidityGauge"></canvas>
                                        </div>
                                        <h6 class="text-center">Humidity</h6>
                                    </div>
                                </div>

                                <!-- ÌíçÏÜçÍ≥º ÌÉúÏñëÎ≥µÏÇ¨Îüâ ÎèÑÎÑõ Ï∞®Ìä∏ -->
                                <div class="row">
                                    <div class="col-6">
                                        <div class="chart-container">
                                            <canvas id="windDonut"></canvas>
                                        </div>
                                        <h6 class="text-center">Wind Speed</h6>
                                    </div>
                                    <div class="col-6">
                                        <div class="chart-container">
                                            <canvas id="solarDonut"></canvas>
                                        </div>
                                        <h6 class="text-center">Solar Radiation</h6>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÏòàÏ∏° ÏÑπÏÖò -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="prediction-card p-4">
                                    <h4><i class="fas fa-crystal-ball"></i> Weather Prediction</h4>
                                    <div class="row">
                                        <div class="col-md-3 text-center">
                                            <h5>+1 Hour</h5>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <i class="fas fa-thermometer-half fa-2x me-2"></i>
                                                <div>
                                                    <div id="predTemp1">25.2¬∞C</div>
                                                    <small>Temperature</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h5>+2 Hours</h5>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <i class="fas fa-tint fa-2x me-2"></i>
                                                <div>
                                                    <div id="predHumidity2">68%</div>
                                                    <small>Humidity</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h5>+3 Hours</h5>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <i class="fas fa-wind fa-2x me-2"></i>
                                                <div>
                                                    <div id="predWind3">2.8 m/s</div>
                                                    <small>Wind Speed</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h5>+4 Hours</h5>
                                            <div class="d-flex justify-content-center align-items-center">
                                                <i class="fas fa-sun fa-2x me-2"></i>
                                                <div>
                                                    <div id="predSolar4">920 W/m¬≤</div>
                                                    <small>Solar Radiation</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÏóêÎÑàÏßÄ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-link"></i> Energy Correlations</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="p-3">
                                                    <h3 class="text-danger" id="tempCorrelation">0.78</h3>
                                                    <p class="mb-0">Temperature vs Consumption</p>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="p-3">
                                                    <h3 class="text-success" id="solarCorrelation">0.92</h3>
                                                    <p class="mb-0">Solar vs Generation</p>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="p-3">
                                                    <h3 class="text-warning" id="humidityCorrelation">-0.45</h3>
                                                    <p class="mb-0">Humidity vs Efficiency</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Ï†ÑÏó≠ Î≥ÄÏàò
            let tempGauge, humidityGauge, windDonut, solarDonut;
            let currentData = {{
                temperature: 24.5,
                humidity: 65,
                windSpeed: 2.3,
                solarRadiation: 850
            }};

            // Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò
            function generateData() {{
                const now = new Date();
                const hour = now.getHours();
                
                // ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∏∞Î≥∏Í∞í
                let baseTemp = 20 + Math.sin((hour - 6) * Math.PI / 12) * 8;
                let baseHumidity = 70 - Math.sin((hour - 6) * Math.PI / 12) * 20;
                let baseWind = 2 + Math.random() * 3;
                let baseSolar = Math.max(0, Math.sin((hour - 6) * Math.PI / 12) * 1000);
                
                // ÎûúÎç§ Î≥ÄÎèô Ï∂îÍ∞Ä
                currentData = {{
                    temperature: baseTemp + (Math.random() - 0.5) * 4,
                    humidity: Math.max(30, Math.min(90, baseHumidity + (Math.random() - 0.5) * 10)),
                    windSpeed: Math.max(0, baseWind + (Math.random() - 0.5) * 2),
                    solarRadiation: Math.max(0, baseSolar + (Math.random() - 0.5) * 200)
                }};
                
                return currentData;
            }}

            // Í≤åÏù¥ÏßÄ Ï∞®Ìä∏ ÏÉùÏÑ±
            function createGaugeChart(canvasId, value, max, color, label) {{
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {{
                    type: 'gauge',
                    data: {{
                        datasets: [{{
                            value: value,
                            minValue: 0,
                            maxValue: max,
                            backgroundColor: [color],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%',
                        circumference: 180,
                        rotation: 270,
                        plugins: {{
                            legend: {{
                                display: false
                            }},
                            tooltip: {{
                                enabled: false
                            }}
                        }},
                        elements: {{
                            arc: {{
                                borderWidth: 0
                            }}
                        }}
                    }}
                }});
            }}

            // ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
            function createDonutChart(canvasId, current, predicted, color, label) {{
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {{
                    type: 'doughnut',
                    data: {{
                        labels: ['Current', 'Predicted'],
                        datasets: [{{
                            data: [current, predicted],
                            backgroundColor: [color, color + '80'],
                            borderWidth: 0
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {{
                            legend: {{
                                display: false
                            }},
                            tooltip: {{
                                callbacks: {{
                                    label: function(context) {{
                                        return context.label + ': ' + context.parsed.toFixed(1);
                                    }}
                                }}
                            }}
                        }}
                    }}
                }});
            }}

            // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            function initializeCharts() {{
                const data = generateData();
                
                // Í≤åÏù¥ÏßÄ Ï∞®Ìä∏ ÏÉùÏÑ±
                tempGauge = createGaugeChart('tempGauge', data.temperature, 40, '#ff6b6b', 'Temperature');
                humidityGauge = createGaugeChart('humidityGauge', data.humidity, 100, '#00b894', 'Humidity');
                
                // ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉùÏÑ±
                windDonut = createDonutChart('windDonut', data.windSpeed, data.windSpeed * 1.2, '#fdcb6e', 'Wind Speed');
                solarDonut = createDonutChart('solarDonut', data.solarRadiation, data.solarRadiation * 1.1, '#74b9ff', 'Solar Radiation');
                
                // Î©îÌä∏Î¶≠ ÏóÖÎç∞Ïù¥Ìä∏
                updateMetrics(data);
                
                // ÏòàÏ∏° Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                updatePredictions(data);
            }}

            // Î©îÌä∏Î¶≠ ÏóÖÎç∞Ïù¥Ìä∏
            function updateMetrics(data) {{
                document.getElementById('currentTemp').textContent = data.temperature.toFixed(1) + '¬∞C';
                document.getElementById('currentHumidity').textContent = data.humidity.toFixed(0) + '%';
                document.getElementById('currentWind').textContent = data.windSpeed.toFixed(1) + ' m/s';
                document.getElementById('currentSolar').textContent = data.solarRadiation.toFixed(0) + ' W/m¬≤';
            }}

            // ÏòàÏ∏° Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            function updatePredictions(data) {{
                document.getElementById('predTemp1').textContent = (data.temperature + 0.7).toFixed(1) + '¬∞C';
                document.getElementById('predHumidity2').textContent = (data.humidity + 3).toFixed(0) + '%';
                document.getElementById('predWind3').textContent = (data.windSpeed + 0.5).toFixed(1) + ' m/s';
                document.getElementById('predSolar4').textContent = (data.solarRadiation + 70).toFixed(0) + ' W/m¬≤';
            }}

            // ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            function updateCorrelations() {{
                document.getElementById('tempCorrelation').textContent = (0.75 + Math.random() * 0.1).toFixed(2);
                document.getElementById('solarCorrelation').textContent = (0.90 + Math.random() * 0.05).toFixed(2);
                document.getElementById('humidityCorrelation').textContent = (-0.40 - Math.random() * 0.1).toFixed(2);
            }}

            // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            function updateData() {{
                const newData = generateData();
                
                // Í≤åÏù¥ÏßÄ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                tempGauge.data.datasets[0].value = newData.temperature;
                humidityGauge.data.datasets[0].value = newData.humidity;
                
                // ÎèÑÎÑõ Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                windDonut.data.datasets[0].data = [newData.windSpeed, newData.windSpeed * 1.2];
                solarDonut.data.datasets[0].data = [newData.solarRadiation, newData.solarRadiation * 1.1];
                
                // Ï∞®Ìä∏ Îã§Ïãú Í∑∏Î¶¨Í∏∞
                tempGauge.update('none');
                humidityGauge.update('none');
                windDonut.update('none');
                solarDonut.update('none');
                
                // Î©îÌä∏Î¶≠ Î∞è ÏòàÏ∏° ÏóÖÎç∞Ïù¥Ìä∏
                updateMetrics(newData);
                updatePredictions(newData);
                updateCorrelations();
            }}

            // Ï¥àÍ∏∞Ìôî
            document.addEventListener('DOMContentLoaded', function() {{
                initializeCharts();
                setInterval(updateData, 5000); // 5Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
            }});
        </script>
    </body>
    </html>
    """

@web_app.get("/data-collection", response_class=HTMLResponse)
async def data_collection_page(request: Request, lang: str = Query("ko", description="Language code")):
    """Data Collection ÌéòÏù¥ÏßÄ - ÌôàÌéòÏù¥ÏßÄÏôÄ ÎèôÏùºÌïú ÎÇ¥Ïö©"""
    return await home_page(request, lang)

@web_app.get("/data-analysis", response_class=HTMLResponse)
async def data_analysis_page(request: Request, lang: str = Query("ko", description="Language code")):
    """Data Analysis ÌéòÏù¥ÏßÄ - ÌôàÌéòÏù¥ÏßÄÏôÄ ÎèôÏùºÌïú ÎÇ¥Ïö©"""
    return await home_page(request, lang)

if __name__ == "__main__":
    # MCP ÎèÑÍµ¨ Îì±Î°ù
    register_tools()
    
    # Ïõπ ÏÑúÎ≤Ñ Ïã§Ìñâ
    uvicorn.run(web_app, host="0.0.0.0", port=8000)

